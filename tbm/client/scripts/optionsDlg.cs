//////////////////////Dynamic List////////////////////////////////
$LCTotal = -1;
$legoColor[$LCTotal++] = "base";
$legoColor[$LCTotal++] = "red";
$legoColor[$LCTotal++] = "orange";
$legoColor[$LCTotal++] = "yellow";
$legoColor[$LCTotal++] = "green";
$legoColor[$LCTotal++] = "blue";
$legoColor[$LCTotal++] = "purple";
$legoColor[$LCTotal++] = "brown";
$legoColor[$LCTotal++] = "white";
$legoColor[$LCTotal++] = "grayDark";
$legoColor[$LCTotal++] = "grey";
$legoColor[$LCTotal++] = "black";
$legoColor[$LCTotal++] = "brightredlilac";
$legoColor[$LCTotal++] = "brightredorange";
$legoColor[$LCTotal++] = "brightredviolet";
$legoColor[$LCTotal++] = "brightyelloworange";
$legoColor[$LCTotal++] = "brightyellowgreen";
$legoColor[$LCTotal++] = "brightbluegreen";
$legoColor[$LCTotal++] = "brightblueviolet";
$legoColor[$LCTotal++] = "yellowmetallic";
$legoColor[$LCTotal++] = "yellowflipflop";
$legoColor[$LCTotal++] = "warmyelloworange";
$legoColor[$LCTotal++] = "violetmetallic";
$legoColor[$LCTotal++] = "turquoise";
$legoColor[$LCTotal++] = "silver";
$legoColor[$LCTotal++] = "sandyellow";
$legoColor[$LCTotal++] = "sandviolet";
$legoColor[$LCTotal++] = "sandred";
$legoColor[$LCTotal++] = "sandgreen";
$legoColor[$LCTotal++] = "sandblue";
$legoColor[$LCTotal++] = "rust";
$legoColor[$LCTotal++] = "royalblue";
$legoColor[$LCTotal++] = "redlilac";
$legoColor[$LCTotal++] = "redflipflop";
$legoColor[$LCTotal++] = "redbrown";
$legoColor[$LCTotal++] = "nougat";
$legoColor[$LCTotal++] = "neonorange";
$legoColor[$LCTotal++] = "neongreen";
$legoColor[$LCTotal++] = "meduimredviolet";
$legoColor[$LCTotal++] = "mediumyelloworange";
$legoColor[$LCTotal++] = "mediumyellowgreen";
$legoColor[$LCTotal++] = "mediumstonegrey";
$legoColor[$LCTotal++] = "mediumroyalblue";
$legoColor[$LCTotal++] = "mediumred";
$legoColor[$LCTotal++] = "mediumorange";
$legoColor[$LCTotal++] = "mediumlilac";
$legoColor[$LCTotal++] = "mediumgreen";
$legoColor[$LCTotal++] = "mediumblueviolet";
$legoColor[$LCTotal++] = "mediumbluegreen";
$legoColor[$LCTotal++] = "mediumblue";
$legoColor[$LCTotal++] = "lilac";
$legoColor[$LCTotal++] = "lightyelloworange";
$legoColor[$LCTotal++] = "lightyellowgreen";
$legoColor[$LCTotal++] = "lightyellow";
$legoColor[$LCTotal++] = "lightstonegrey";
$legoColor[$LCTotal++] = "lightroyalblue";
$legoColor[$LCTotal++] = "lightreddishviolet";
$legoColor[$LCTotal++] = "lightred";
$legoColor[$LCTotal++] = "lightpurple";
$legoColor[$LCTotal++] = "lightpink";
$legoColor[$LCTotal++] = "lightorangebrown";
$legoColor[$LCTotal++] = "lightorange";
$legoColor[$LCTotal++] = "lightlilac";
$legoColor[$LCTotal++] = "lightgreymetallic";
$legoColor[$LCTotal++] = "lightgrey";
$legoColor[$LCTotal++] = "lightgreen";
$legoColor[$LCTotal++] = "lightbrickyellow";
$legoColor[$LCTotal++] = "lightblueishviolet";
$legoColor[$LCTotal++] = "lightbluegreen";
$legoColor[$LCTotal++] = "lightblue";
$legoColor[$LCTotal++] = "lemonmetallic";
$legoColor[$LCTotal++] = "gunmetallic";
$legoColor[$LCTotal++] = "greyflipflop";
$legoColor[$LCTotal++] = "gold";
$legoColor[$LCTotal++] = "flameyelloworange";
$legoColor[$LCTotal++] = "flameredorange";
$legoColor[$LCTotal++] = "fireyellow";
$legoColor[$LCTotal++] = "fadedgreen";
$legoColor[$LCTotal++] = "earthorange";
$legoColor[$LCTotal++] = "earthgreen";
$legoColor[$LCTotal++] = "earthblue";
$legoColor[$LCTotal++] = "doveblue";
$legoColor[$LCTotal++] = "darkstonegrey";
$legoColor[$LCTotal++] = "darkroyalblue";
$legoColor[$LCTotal++] = "darkred";
$legoColor[$LCTotal++] = "darkorange";
$legoColor[$LCTotal++] = "darknougat";
$legoColor[$LCTotal++] = "darkgreymetallic";
$legoColor[$LCTotal++] = "darkgreen";
$legoColor[$LCTotal++] = "darkcurry";
$legoColor[$LCTotal++] = "curry";
$legoColor[$LCTotal++] = "coolyellow";
$legoColor[$LCTotal++] = "brickyellow";
$legoColor[$LCTotal++] = "bluemetallic";
$legoColor[$LCTotal++] = "blackmetallic";
$legoColor[$LCTotal++] = "greychecker";
$legoColor[$LCTotal++] = "olivechecker";
$legoColor[$LCTotal++] = "blackchecker";
$legoColor[$LCTotal++] = "bluechecker";
$legoColor[$LCTotal++] = "stripe";
$legoColor[$LCTotal++] = "grass";
$legoColor[$LCTotal++] = "ice";
$legoColor[$LCTotal++] = "sand";
$legoColor[$LCTotal++] = "rock";
$legoColor[$LCTotal++] = "water";
$legoColor[$LCTotal++] = "lava";
$legoColor[$LCTotal++] = "wood";
$legoColor[$LCTotal++] = "wood2";
$legoColor[$LCTotal++] = "crate";
$legoColor[$LCTotal++] = "metal";
$legoColor[$LCTotal++] = "concrete";
$legoColor[$LCTotal++] = "stone";
$legoColor[$LCTotal++] = "brick";
$legoColor[$LCTotal++] = "Gird";
$legoColor[$LCTotal++] = "metal2";
$legoColor[$LCTotal++] = "metal3";
$legoColor[$LCTotal++] = "hay";
$legoColor[$LCTotal++] = "shingle";
$legoColor[$LCTotal++] = "camo";
$legoColor[$LCTotal++] = "camo2";
$legoColor[$LCTotal++] = "camo3";
$legoColor[$LCTotal++] = "camo4";

$hatsTot = -1;
$hats[$hatsTot] = "None";
$hats[$hatsTot++] = "Helmet";
$hats[$hatsTot++] = "Scout Hat";
$hats[$hatsTot++] = "Pointy Helmet";
$hats[$hatsTot++] = "Male Hair";
$hats[$hatsTot++] = "Female Hair";
$hats[$hatsTot++] = "Female Hair 2";
$hats[$hatsTot++] = "Wizard Hat";
$hats[$hatsTot++] = "Cowboy Hat";
$hats[$hatsTot++] = "Pirate Hat";
$hats[$hatsTot++] = "Navy Hat";
$hats[$hatsTot++] = "Darth Vader";
$hats[$hatsTot++] = "Samurai Helmet";
$hats[$hatsTot++] = "Fro";
$hats[$hatsTot++] = "Army Helmet";
$hats[$hatsTot++] = "Cap";
$hats[$hatsTot++] = "Police";
$hats[$hatsTot++] = "Top Hat";
$hats[$hatsTot++] = "Aviator";
$hats[$hatsTot++] = "Ninja Mask";
$hats[$hatsTot++] = "Batman Helmet";
$hats[$hatsTot++] = "Crown";
$hats[$hatsTot++] = "Darth Maul";
$hats[$hatsTot++] = "Fire Man";
$hats[$hatsTot++] = "Islander Mask";
$hats[$hatsTot++] = "Jedi Hood";
$hats[$hatsTot++] = "Spider Man";
$hats[$hatsTot++] = "Dictator Hat";
$hats[$hatsTot++] = "Storm Trooper Helmet";
$hats[$hatsTot++] = "Burger King";
$hats[$hatsTot++] = "Flat Top";
$hats[$hatsTot++] = "Ponytail";
$hats[$hatsTot++] = "Clone Trooper Helmet";
$hats[$hatsTot++] = "Mandalorian Helmet";
$hats[$hatsTot++] = "ARC Trooper Helmet";

$backTot = -1;
$backstuff[$backTot] = "None";
$backstuff[$backTot++] = "Cape";
$backstuff[$backTot++] = "Bucket";
$backstuff[$backTot++] = "Quiver";
$backstuff[$backTot++] = "Plate Mail";
$backstuff[$backTot++] = "Pack";
$backstuff[$backTot++] = "Air Tank";
$backstuff[$backTot++] = "Cloak";
$backstuff[$backTot++] = "Samurai";
$backstuff[$backTot++] = "Scuba";
$backstuff[$backTot++] = "Epaulets";
$backstuff[$backTot++] = "Astromech";

$armsTot = 0;
$armscolor[$armsTot] = "Black";
$armscolor[$armsTot++] = "Blue";
$armscolor[$armsTot++] = "Green";
$armscolor[$armsTot++] = "Red";
$armscolor[$armsTot++] = "Yellow";
$armscolor[$armsTot++] = "Brown";
$armscolor[$armsTot++] = "Gray";
$armscolor[$armsTot++] = "GrayDark";
$armscolor[$armsTot++] = "White";
$armscolor[$armsTot++] = "Droid";
$armscolor[$armsTot++] = "Shortie";

$DHatsTot = 0;
$Dhats[$DHatsTot]   = "Battle Droid";
$Dhats[$DHatsTot++] = "Flat";
$Dhats[$DHatsTot++] = "IG-88";
$Dhats[$DhatsTot++] = "None";

$DBackTot = -1;
$DBackStuff[$DBackTot]   = "None";
$DBackStuff[$DBackTot++] = "Cloak";
$DBackStuff[$DBackTot++] = "Astromech";

/////////////////////////////////////////////////////////////////
function optionsDlg::setPane(%this, %pane)
{
   OptAudioPane.setVisible(false);
   OptGraphicsPane.setVisible(false);
   OptNetworkPane.setVisible(false);
   OptControlsPane.setVisible(false);
   OptPlayerPane.setVisible(false);
   ("Opt" @ %pane @ "Pane").setVisible(true);
   OptRemapList.fillList();
}

function OptionsDlg::onWake(%this)
{
   setmodpaths(getmodpaths());
   optionsDlgWindow.resize((getWord($Pref::Video::Resolution, 0) > 800 ? 192 : 0), ((getWord($Pref::Video::Resolution, 1) / 2) - 192), getWord(optionsDlgWindow.extent, 0), getWord(optionsDlgWindow.extent, 1));
   $OptionsDlgButtonSchedule = schedule(50, 0, optionsDlgButtonCheck);
   DecalOPBG($legoColor[$pref::Color::skin]);
   playerPV();
   $OptionsGuiTog = 1;
   //%this.setPane(Graphics);
   %buffer = getDisplayDeviceList();
   %count = getFieldCount( %buffer );
   OptGraphicsDriverMenu.clear();
   OptScreenshotMenu.init();
   OptScreenshotMenu.setValue($pref::Video::screenShotFormat);
   for(%i = 0; %i < %count; %i++)
      OptGraphicsDriverMenu.add(getField(%buffer, %i), %i);
   %selId = OptGraphicsDriverMenu.findText( $pref::Video::displayDevice );
	if ( %selId == -1 )
		%selId = 0; // How did THAT happen?
	OptGraphicsDriverMenu.setSelected( %selId );
	OptGraphicsDriverMenu.onSelect( %selId, "" );
   radFilmstrip.setValue(!$Pref::GUI::BuildPreviews);
   radPreviewBuilds.setValue($Pref::GUI::BuildPreviews);


   // Audio 
   OptAudioUpdate();
   OptAudioVolumeMaster.setValue( $pref::Audio::masterVolume);
   OptAudioVolumeShell.setValue(  $pref::Audio::channelVolume[$GuiAudioType]);
   OptAudioVolumeSim.setValue(    $pref::Audio::channelVolume[$SimAudioType]);
   OptAudioDriverList.clear();
   OptAudioDriverList.add("OpenAL", 1);
   OptAudioDriverList.add("none", 2);
   %selId = OptAudioDriverList.findText($pref::Audio::driver);
	if ( %selId == -1 )
		%selId = 0; // How did THAT happen?
	OptAudioDriverList.setSelected( %selId );
	OptAudioDriverList.onSelect( %selId, "" );

	//player prefs
	TxtPlayerName.setValue($pref::Player::Name);

	//clear the menu first to prevent dup entries

	OptPlayerHeadMenu.clear();
	if($armsColor[$Pref::Accessory::armscolor] !$= "Droid") {
	        for(%i = 0; %i <= $hatsTot; %i++)
			OptPlayerHeadMenu.add($hats[%i], %i);
		OptPlayerHeadMenu.sort();
		OptPlayerHeadMenu.add($hats[-1], -1);
	}
	else {
	        for(%i = -1; %i <= $DhatsTot; %i++)
			OptPlayerHeadMenu.add($Dhats[%i], %i);
		OptPlayerHeadMenu.sort();
	}
    	OptPlayerHeadMenu.onSelect();

	OptPlayerBackMenu.clear();
	if($armsColor[$Pref::Accessory::armscolor] !$= "Droid") {
	        for(%i = 0; %i <= $backTot; %i++)
			OptPlayerBackMenu.add($backstuff[%i], %i);
		OptPlayerBackMenu.sort();
		OptPlayerBackMenu.add($backstuff[-1], -1);
	}
	else {
	        for (%i = 0; %i <= $DBackTot; %i++)
			OptPlayerBackMenu.add($DBackStuff[%i], %i);
		OptPlayerBackMenu.sort();
		OptPlayerBackMenu.add($DBackStuff[-1], -1);
	}

    armsncrotchpopup.clear();
    for (%i = 0; %i <= $armsTot; %i++)
        armsncrotchpopup.add($armscolor[%i], %i);

    OptWindowColorMenu.clear();
	for (%i = $wintot; %i > 0; %i--)
        {
	OptWindowColorMenu.add($windowsn[%i], %i);
        }
    OptPlayerHeadMenu.setSelected($pref::Accessory::headCode);
    OptPlayerBackMenu.setSelected($pref::Accessory::BackCode);
    armsncrotchpopup.setSelected($pref::Accessory::armscolor);
        setcolorsettings();
	OptWindowColorMenu.setSelected($pref::Gui::Skin);

///////////////////////////////////////////////LeftHand///////////////////////////////////////
	OptPlayerLeftHandMenu.clear();
	OptPlayerLeftHandMenu.add("Beard", 2);
	OptPlayerLeftHandMenu.add("Bikini", 7);
	OptPlayerLeftHandMenu.add("Bird", 6);
	OptPlayerLeftHandMenu.add("Briefcase", 8);
	OptPlayerLeftHandMenu.add("Broom", 4);
	OptPlayerLeftHandMenu.add("Goblet", 1);
	OptPlayerLeftHandMenu.add("Shield", 0);
	OptPlayerLeftHandMenu.add("Sickle", 3);
	OptPlayerLeftHandMenu.add("Vanity Mug", 9);
	OptPlayerLeftHandMenu.add("Whip", 5);
	OptPlayerLeftHandMenu.sort();
	OptPlayerLeftHandMenu.add("None", -1);
	OptPlayerLeftHandMenu.setSelected($pref::Accessory::leftHandCode);

	//controls
	SliderControlsMouseSensitivity.setValue($pref::Input::MouseSensitivity);

	//graphics
	//SliderGraphicsAnisotropy.setValue($pref::OpenGL::Anisotropy);
	SliderGraphicsDistanceMod.setValue($pref::visibleDistanceMod);

	//network
	PacketSizeDisplay.setValue($pref::Net::PacketSize);
	SliderPacketSize.setValue($pref::Net::PacketSize);

	LagThresholdDisplay.setValue($pref::Net::LagThreshold);
	SliderLagThreshold.setValue($pref::Net::LagThreshold);

	RateToClientDisplay.setValue($pref::Net::PacketRateToClient);
	SliderRateToClient.setValue($pref::Net::PacketRateToClient);

	RateToServerDisplay.setValue($pref::Net::PacketRateToServer);
	SliderRateToServer.setValue($pref::Net::PacketRateToServer);

	TxtMasterServer.setValue($pref::Master0);
}

function OptionsDlg::onSleep(%this)
{
	$OptionsGuiTog = 0;
	//write out the config
	moveMap.save( "TBM/client/config.cs" );

	//save player prefs
    if($savingplayer == false)
	$pref::Player::Name = TxtPlayerName.getValue();
	$pref::Input::MouseSensitivity = SliderControlsMouseSensitivity.getValue();
	//$pref::OpenGL::Anisotropy = SliderGraphicsAnisotropy.getValue();
	$pref::visibleDistanceMod = SliderGraphicsDistanceMod.getValue();

	$pref::Accessory::headCode = OptPlayerHeadMenu.getSelected();
	$pref::Accessory::visorCode = OptPlayerVisorMenu.getSelected();
	$pref::Accessory::BackCode = OptPlayerBackMenu.getSelected();
	$pref::Accessory::leftHandCode = OptPlayerLeftHandMenu.getSelected();
//	$pref::Accessory::leftHandColor = OptPlayerLeftHandColorMenu.getSelected();
    $pref::Accessory::Armscolor = armsncrotchpopup.getSelected();
    if(OptWindowColorMenu.getSelected() > 0)
    $pref::Gui::Skin = OptWindowColorMenu.getSelected();

	$pref::Master0 = TxtMasterServer.getValue();

	//send our prefs to the server
	clientCmdUpdatePrefs();
    setFPSvis();
    exportTBMPrefs();
    moveMap.save("~/client/config.cs");
}

function optionsDlgButtonCheck() {
    cancel($OptionsDlgButtonSchedule);
    if(optionsDlg.isAwake()) {
		if(isMouseoverbutton("Options_Graphics") == 1 && !Options_Graphics.on && Options_Graphics.isVisible())
			fadebutton("Button_Graphics_Bitmap","Options_Graphics");

		else if(isMouseoverbutton("Options_Audio") == 1 && !Options_Audio.on && Options_Audio.isVisible())
			fadebutton("Button_Audio_Bitmap","Options_Audio");

		else if(isMouseoverbutton("Options_Network") == 1 && !Options_Network.on && Options_Network.isVisible())
			fadebutton("Button_Network_Bitmap","Options_Network");

		else if(isMouseoverbutton("Options_Controls") == 1 && !Options_Controls.on && Options_Controls.isVisible())
			fadebutton("Button_Controls_Bitmap","Options_Controls");

		else if(isMouseoverbutton("Options_Player") == 1 && !Options_Player.on && Options_Player.isVisible())
			fadebutton("Button_Player_Bitmap","Options_Player");
    $OptionsDlgButtonSchedule = schedule(50, 0, optionsDlgButtonCheck);
    }
}

//hackyest Hackyiest HAxx evar --gobbles
//Not any more --Billy Mays
function setWindowStyle() {
getGuiStyle(OptWindowColorMenu.getSelected());
}

function popOpenWindows() {
for(%i=0;%i<=Canvas.getCount();%i++) {
%window = Canvas.getObject(%i);
echo(%window);
if(%window.getname() $= "MainMenuGui")
continue;
Canvas.popDialog(%window);
schedule(10,0,"schedulepushWindow",%window);
}
}
function schedulepushWindow(%window) {
Canvas.pushDialog(%window);
}
function OptPlayerHeadMenu::onSelect( %this, %id, %text )
{
	//update visor and visor color menus based on id
	%headcode = OptPlayerHeadMenu.getSelected();

	OptPlayerVisorMenu.clear();
	if($armsColor[$Pref::Accessory::armscolor] !$= "Droid") {
		OptPlayerVisorMenu.add("Band", 3);
		OptPlayerVisorMenu.add("Feather?", 4);
		OptPlayerVisorMenu.add("Goggles", 5);
		OptPlayerVisorMenu.add("Horn", 2);
		OptPlayerVisorMenu.add("Horns", 6);
		OptPlayerVisorMenu.add("Snorkel", 7);
		OptPlayerVisorMenu.add("Tri-Plume", 0);
		OptPlayerVisorMenu.add("Visor", 1);
		OptPlayerVisorMenu.add("None", -1);
		OptPlayerVisorMenu.setSelected(-1);
	}
	else {
		OptPlayerVisorMenu.add("None", -1);
		$pref::Accessory::visorCode = -1;
	}
	//if the pref isnt in the list, pick none

	%text = OptPlayerVisorMenu.getTextById($pref::Accessory::visorCode);

	if(%text !$= "")
	{
		OptPlayerVisorMenu.setSelected($pref::Accessory::visorCode);
    }
    if(isFile("tbm/client/ui/previewimages/hats/"@$hats[%headcode]@".png"))
    previewHead.setBitmap("tbm/client/ui/previewimages/hats/"@$hats[%headcode]@".png");
    else
    previewHead.setBitmap("tbm/client/ui/previewimages/hats/none.png");
}	

function ArmsNCrotchPopup::onSelect(%this, %id, %text) {
if(%text $= "Droid" && $armsColor[$Pref::Accessory::armscolor] !$= "Droid") {
	//Droid has been selected; clear the list and load the new one up.
	OptPlayerHeadMenu.clear();
        for (%i = -1; %i <= $DhatsTot; %i++) {
		OptPlayerHeadMenu.add($Dhats[%i], %i);
       	}
	OptPlayerBackMenu.clear();
        for (%i = -1; %i <= $DBackTot; %i++) {
		OptPlayerBackMenu.add($DBackStuff[%i], %i);
	}
	OptPlayerVisorMenu.clear();
	OptPlayerVisorMenu.add("None", -1);
	OptPlayerVisorMenu.setSelected($pref::Accessory::visorCode = -1);
	OptPlayerHeadMenu.setSelected($pref::Accessory::headCode = 0);
	OptPlayerBackMenu.setSelected($pref::Accessory::BackCode = -1);
}
if(%text !$= "Droid" && $armsColor[$Pref::Accessory::armscolor] $= "Droid") {
	//Droid has been unselected; clear the list and load the new one up.
	OptPlayerHeadMenu.clear();
        for (%i = -1; %i <= $hatsTot; %i++) {
		OptPlayerHeadMenu.add($hats[%i], %i);
       	}
	OptPlayerBackMenu.clear();
        for (%i = -1; %i <= $backTot; %i++) {
		OptPlayerBackMenu.add($backstuff[%i], %i);
	}
	OptPlayerVisorMenu.clear();
	OptPlayerVisorMenu.add("None", -1);
	OptPlayerVisorMenu.add("Horns", 6);
	OptPlayerVisorMenu.add("Goggles", 5);
	OptPlayerVisorMenu.add("Visor", 1);
	OptPlayerVisorMenu.add("Tri-Plume", 0);
	OptPlayerVisorMenu.add("Horn", 2);
	OptPlayerVisorMenu.add("Band", 3);
	OptPlayerVisorMenu.add("Feather?", 4);
	OptPlayerVisorMenu.add("Snorkel", 7);
	OptPlayerVisorMenu.setSelected(-1);
	OptPlayerVisorMenu.setSelected($pref::Accessory::visorCode = -1);
	OptPlayerHeadMenu.setSelected($pref::Accessory::headCode = -1);
	OptPlayerBackMenu.setSelected($pref::Accessory::BackCode = -1);
}
}	

function UpdatePacketSize()
{
	PacketSizeDisplay.setValue(mFloor(SliderPacketSize.getValue()));
	$pref::Net::PacketSize = PacketSizeDisplay.getValue();
}
function UpdateLagThreshold()
{
	LagThresholdDisplay.setValue(mFloor(SliderLagThreshold.getValue()));
	$pref::Net::LagThreshold = LagThresholdDisplay.getValue();
}

function UpdateRateToClient()
{
	RateToClientDisplay.setValue(mFloor(SliderRateToClient.getValue()));
	$pref::Net::PacketRateToClient = RateToClientDisplay.getValue();
}

function UpdateRateToServer()
{
	RateToServerDisplay.setValue(mFloor(SliderRateToServer.getValue()));
	$pref::Net::PacketRateToServer = RateToServerDisplay.getValue();
}

function OptGraphicsDriverMenu::onSelect( %this, %id, %text )
{
	// Attempt to keep the same res and bpp settings:
	if ( OptGraphicsResolutionMenu.size() > 0 )
		%prevRes = OptGraphicsResolutionMenu.getText();
	else
		%prevRes = getWords( $pref::Video::resolution, 0, 1 );

	// Check if this device is full-screen only:
	if ( isDeviceFullScreenOnly( %this.getText() ) )
	{
		OptGraphicsFullscreenToggle.setValue( true );
		OptGraphicsFullscreenToggle.setActive( false );
		OptGraphicsFullscreenToggle.onAction();
	}
	else
		OptGraphicsFullscreenToggle.setActive( true );

	if ( OptGraphicsFullscreenToggle.getValue() )
	{
		if ( OptGraphicsBPPMenu.size() > 0 )
			%prevBPP = OptGraphicsBPPMenu.getText();
		else
			%prevBPP = getWord( $pref::Video::resolution, 2 );
	}

	// Fill the resolution and bit depth lists:
	OptGraphicsResolutionMenu.init( %this.getText(), OptGraphicsFullscreenToggle.getValue() );
	OptGraphicsBPPMenu.init( %this.getText() );

	// Try to select the previous settings:
	%selId = OptGraphicsResolutionMenu.findText( %prevRes );
	if ( %selId == -1 )
		%selId = 0;
	OptGraphicsResolutionMenu.setSelected( %selId );

	if ( OptGraphicsFullscreenToggle.getValue() )
	{
		%selId = OptGraphicsBPPMenu.findText( %prevBPP );
		if ( %selId == -1 )
			%selId = 0;
		OptGraphicsBPPMenu.setSelected( %selId );
		OptGraphicsBPPMenu.setText( OptGraphicsBPPMenu.getTextById( %selId ) );
	}
	else
		OptGraphicsBPPMenu.setText( "Default" );

}

function OptGraphicsResolutionMenu::init( %this, %device, %fullScreen )
{
	%this.clear();
	%resList = getResolutionList( %device );
	%resCount = getFieldCount( %resList );
	%deskRes = getDesktopResolution();

   %count = 0;
	for ( %i = 0; %i < %resCount; %i++ )
	{
		%res = getWords( getField( %resList, %i ), 0, 1 );

		if ( !%fullScreen )
		{
			if ( firstWord( %res ) >= firstWord( %deskRes ) )
				continue;
			if ( getWord( %res, 1 ) >= getWord( %deskRes, 1 ) )
				continue;
		}

		// Only add to list if it isn't there already:
		if ( %this.findText( %res ) == -1 )
      {
			%this.add( %res, %count );
         %count++;
      }
	}
}

function OptGraphicsFullscreenToggle::onAction(%this)
{
   Parent::onAction();
   %prevRes = OptGraphicsResolutionMenu.getText();

   // Update the resolution menu with the new options
   OptGraphicsResolutionMenu.init( OptGraphicsDriverMenu.getText(), %this.getValue() );

   // Set it back to the previous resolution if the new mode supports it.
   %selId = OptGraphicsResolutionMenu.findText( %prevRes );
   if ( %selId == -1 )
   	%selId = 0;
 	OptGraphicsResolutionMenu.setSelected( %selId );
}


function OptGraphicsBPPMenu::init( %this, %device )
{
	%this.clear();

	if ( %device $= "Voodoo2" )
		%this.add( "16", 0 );
	else
	{
		%resList = getResolutionList( %device );
		%resCount = getFieldCount( %resList );
      %count = 0;
		for ( %i = 0; %i < %resCount; %i++ )
		{
			%bpp = getWord( getField( %resList, %i ), 2 );

			// Only add to list if it isn't there already:
			if ( %this.findText( %bpp ) == -1 )
         {
				%this.add( %bpp, %count );
            %count++;
         }
		}
	}
}

function OptScreenshotMenu::init( %this )
{
   if( %this.findText("PNG") == -1 )
      %this.add("PNG", 0);
   if( %this.findText("JPEG") == - 1 )
      %this.add("JPEG", 1);
}

function optionsDlg::applyGraphics( %this )
{
	%newDriver = OptGraphicsDriverMenu.getText();
	%newRes = OptGraphicsResolutionMenu.getText();
	%newBpp = OptGraphicsBPPMenu.getText();
	%newFullScreen = OptGraphicsFullscreenToggle.getValue();
	$pref::Video::screenShotFormat = OptScreenshotMenu.getText();

	if ( %newDriver !$= $pref::Video::displayDevice )
	{
		setDisplayDevice( %newDriver, firstWord( %newRes ), getWord( %newRes, 1 ), %newBpp, %newFullScreen );
		//OptionsDlg::deviceDependent( %this );
	}
	else
	{
		setScreenMode( firstWord( %newRes ), getWord( %newRes, 1 ), %newBpp, %newFullScreen );
		optionsDlgWindow.resize((getWord($Pref::Video::Resolution, 0) > 800 ? 192 : 0), ((getWord($Pref::Video::Resolution, 1) / 2) - 192), getWord(optionsDlgWindow.extent, 0), getWord(optionsDlgWindow.extent, 1));
	}
}

function optionsDlg::applyPlayer( %this )
{
	echo("applying player attributes");
	$pref::Player::Name = TxtPlayerName.getValue();
}
function teamtog(%val) {if (%val == 1) TeamListGui.toggle();}
function playlisttog(%val) {if (%val == 1) PlayerListGui.toggle();}
function suicide(%val) {if (%val == 1) commandToServer('suicide');}

$RemapCount = 0;
$RemapName[$RemapCount] = "Options Window";
$RemapCmd[$RemapCount] = "openOptionsWindow";
$RemapCount++;
$RemapName[$RemapCount] = "Admin Window";
$RemapCmd[$RemapCount] = "openAdminWindow";
$RemapCount++;
$RemapName[$RemapCount] = "Join Server Window";
$RemapCmd[$RemapCount] = "togglejoinservergui";
$RemapCount++;
$RemapName[$RemapCount] = "iGob Window";
$RemapCmd[$RemapCount] = "openiGobWindow";
$RemapCount++;
$RemapName[$RemapCount] = "Editor Menu";
$RemapCmd[$RemapCount] = "SpecialOpGui";
$RemapCount++;
$RemapName[$RemapCount] = "Color Pallet";
$RemapCmd[$RemapCount] = "colorpl";
$RemapCount++;
$RemapName[$RemapCount] = "Decal Pallet";
$RemapCmd[$RemapCount] = "opendecalPalletWindow";
$RemapCount++;
$RemapName[$RemapCount] = "Advanced Prefs Editor";
$RemapCmd[$RemapCount] = "Advancedprefstog";
$RemapCount++;
$RemapName[$RemapCount] = "TBM Player Options Bar";
$RemapCmd[$RemapCount] = "TBMplayeropGUI";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Player List";
$RemapCmd[$RemapCount] = "playlisttog";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Team List";
$RemapCmd[$RemapCount] = "teamtog";
$RemapCount++;
$RemapName[$RemapCount] = "Quick Inventory";
$RemapCmd[$RemapCount] = "togQuickInventoryGui";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Message Hud";
$RemapCmd[$RemapCount] = "toggleMessageHud";
$RemapCount++;
$RemapName[$RemapCount] = "Message Hud PageUp";
$RemapCmd[$RemapCount] = "pageMessageHudUp";
$RemapCount++;
$RemapName[$RemapCount] = "Message Hud PageDown";
$RemapCmd[$RemapCount] = "pageMessageHudDown";
$RemapCount++;
$RemapName[$RemapCount] = "Resize Message Hud";
$RemapCmd[$RemapCount] = "resizeMessageHud";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Huds";
$RemapCmd[$RemapCount] = "ToggleHuds";
$RemapCount++;
$RemapName[$RemapCount] = "Screen Shot";
$RemapCmd[$RemapCount] = "doScreenShot";
$RemapCount++;
$RemapName[$RemapCount] = "Forward";
$RemapCmd[$RemapCount] = "moveforward";
$RemapCount++;
$RemapName[$RemapCount] = "Backward";
$RemapCmd[$RemapCount] = "movebackward";
$RemapCount++;
$RemapName[$RemapCount] = "Strafe Left";
$RemapCmd[$RemapCount] = "moveleft";
$RemapCount++;
$RemapName[$RemapCount] = "Strafe Right";
$RemapCmd[$RemapCount] = "moveright";
$RemapCount++;
$RemapName[$RemapCount] = "Turn Left";
$RemapCmd[$RemapCount] = "turnLeft";
$RemapCount++;
$RemapName[$RemapCount] = "Turn Right";
$RemapCmd[$RemapCount] = "turnRight";
$RemapCount++;
$RemapName[$RemapCount] = "Look Up";
$RemapCmd[$RemapCount] = "panUp";
$RemapCount++;
$RemapName[$RemapCount] = "Look Down";
$RemapCmd[$RemapCount] = "panDown";
$RemapCount++;
$RemapName[$RemapCount] = "Jump";
$RemapCmd[$RemapCount] = "jump";
$RemapCount++;
$RemapName[$RemapCount] = "Walk";  //FWAR 
$RemapCmd[$RemapCount] = "walk";
$RemapCount++;
$RemapName[$RemapCount] = "Crouch";  //FWAR 
$RemapCmd[$RemapCount] = "crouch";
$RemapCount++;
$RemapName[$RemapCount] = "Jet";  //FWAR 
$RemapCmd[$RemapCount] = "jet";
$RemapCount++;
$RemapName[$RemapCount] = "Fire Weapon";
$RemapCmd[$RemapCount] = "mouseFire";
$RemapCount++;
$RemapName[$RemapCount] = "Suicide";
$RemapCmd[$RemapCount] = "suicide";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Zoom";
$RemapCmd[$RemapCount] = "toggleZoom";
$RemapCount++;
$RemapName[$RemapCount] = "Static Zoom";
$RemapCmd[$RemapCount] = "staticzoom";
$RemapCount++;
$RemapName[$RemapCount] = "Enter/Exit Vehicle"; 
$RemapCmd[$RemapCount] = "getinbuggy";
$RemapCount++;
$RemapName[$RemapCount] = "Free Look";
$RemapCmd[$RemapCount] = "toggleFreeLook";
$RemapCount++;
$RemapName[$RemapCount] = "Switch 1st/3rd";
$RemapCmd[$RemapCount] = "toggleFirstPerson";
$RemapCount++;
$RemapName[$RemapCount] = "Drop Camera at Player";
$RemapCmd[$RemapCount] = "dropCameraAtPlayer";
$RemapCount++;
$RemapName[$RemapCount] = "Drop Player at Camera";
$RemapCmd[$RemapCount] = "dropPlayerAtCamera";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Inventories";
$RemapCmd[$RemapCount] = "switchinv";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Hammer"; 
$RemapCmd[$RemapCount] = "togham";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle SprayCan"; 
$RemapCmd[$RemapCount] = "togsc"; 
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Editor Mode"; 
$RemapCmd[$RemapCount] = "togedit";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Gun Editor Mode";
$RemapCmd[$RemapCount] = "toggunedit";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle Eye Dropper";
$RemapCmd[$RemapCount] = "togeyed";
$RemapCount++;
$RemapName[$RemapCount] = "Toggle iGob";
$RemapCmd[$RemapCount] = "toggleigob";
$RemapCount++;
$RemapName[$RemapCount] = "iGob Cut";
$RemapCmd[$RemapCount] = "igobcut";
$RemapCount++;
$RemapName[$RemapCount] = "iGob Copy";
$RemapCmd[$RemapCount] = "igobcopy";
$RemapCount++;
$RemapName[$RemapCount] = "iGob Paste";
$RemapCmd[$RemapCount] = "igobpaste";
$RemapCount++;
$RemapName[$RemapCount] = "Delete Selected Brick(s)";
$RemapCmd[$RemapCount] = "deleteselected";
$RemapCount++;
$RemapName[$RemapCount] = "Refresh Spy";
$RemapCmd[$RemapCount] = "cspy";
$RemapCount++;
$RemapName[$RemapCount] = "Spy Next"; 
$RemapCmd[$RemapCount] = "cspy1";
$RemapCount++;
$RemapName[$RemapCount] = "Rotate Brick CW";
$RemapCmd[$RemapCount] = "RotateBrickCW";
$RemapCount++;
$RemapName[$RemapCount] = "Rotate Brick CCW";
$RemapCmd[$RemapCount] = "RotateBrickCCW";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Away";
$RemapCmd[$RemapCount] = "shiftBrickAway";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Away x10";
$RemapCmd[$RemapCount] = "sshiftBrickAway";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Towards";
$RemapCmd[$RemapCount] = "shiftBrickTowards";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Towards x10";
$RemapCmd[$RemapCount] = "sshiftBrickTowards";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Left";
$RemapCmd[$RemapCount] = "shiftBrickLeft";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Left x10";
$RemapCmd[$RemapCount] = "sshiftBrickLeft";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Right";
$RemapCmd[$RemapCount] = "shiftBrickRight";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Right x10";
$RemapCmd[$RemapCount] = "sshiftBrickRight";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Up x1/3";
$RemapCmd[$RemapCount] = "shiftBrickThirdUp";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Up";
$RemapCmd[$RemapCount] = "shiftBrickUp";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Up x10";
$RemapCmd[$RemapCount] = "sshiftBrickUp";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Down x1/3";
$RemapCmd[$RemapCount] = "shiftBrickThirdDown";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Down";
$RemapCmd[$RemapCount] = "shiftBrickDown";
$RemapCount++;
$RemapName[$RemapCount] = "Shift Brick Down x10";
$RemapCmd[$RemapCount] = "sshiftBrickDown";
$RemapCount++;
$RemapName[$RemapCount] = "Scale Up";
$RemapCmd[$RemapCount] = "scaleup";
$RemapCount++;
$RemapName[$RemapCount] = "Scale Up x10"; 
$RemapCmd[$RemapCount] = "sscaleup";
$RemapCount++;
$RemapName[$RemapCount] = "Scale Down"; 
$RemapCmd[$RemapCount] = "scaledown";
$RemapCount++;
$RemapName[$RemapCount] = "Scale Down x10"; 
$RemapCmd[$RemapCount] = "sscaledown";
$RemapCount++;
$RemapName[$RemapCount] = "Plant Brick";
$RemapCmd[$RemapCount] = "plantBrick";
$RemapCount++;
$RemapName[$RemapCount] = "Cancel Brick";
$RemapCmd[$RemapCount] = "cancelBrick";
$RemapCount++;
$RemapName[$RemapCount] = "Use 1st Slot";
$RemapCmd[$RemapCount] = "useFirstSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 2nd Slot";
$RemapCmd[$RemapCount] = "useSecondSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 3rd Slot";
$RemapCmd[$RemapCount] = "useThirdSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 4th Slot";
$RemapCmd[$RemapCount] = "useFourthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 5th Slot";
$RemapCmd[$RemapCount] = "useFifthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 6th Slot";
$RemapCmd[$RemapCount] = "useSixthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 7th Slot";
$RemapCmd[$RemapCount] = "useSeventhSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 8th Slot";
$RemapCmd[$RemapCount] = "useEighthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 9th Slot";
$RemapCmd[$RemapCount] = "useNinthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Use 10th Slot";
$RemapCmd[$RemapCount] = "useTenthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 1st Slot";
$RemapCmd[$RemapCount] = "dropFirstSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 2nd Slot";
$RemapCmd[$RemapCount] = "dropSecondSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 3rd Slot";
$RemapCmd[$RemapCount] = "dropThirdSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 4th Slot";
$RemapCmd[$RemapCount] = "dropFourthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 5th Slot";
$RemapCmd[$RemapCount] = "dropFifthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 6th Slot";
$RemapCmd[$RemapCount] = "dropSixthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 7th Slot";
$RemapCmd[$RemapCount] = "dropSeventhSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 8th Slot";
$RemapCmd[$RemapCount] = "dropEighthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 9th Slot";
$RemapCmd[$RemapCount] = "dropNinthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Drop 10th Slot";
$RemapCmd[$RemapCount] = "dropTenthSlot";
$RemapCount++;
$RemapName[$RemapCount] = "Emote Question";
$RemapCmd[$RemapCount] = "emoteQuestion";
$RemapCount++;
$RemapName[$RemapCount] = "Emote Exclaim";
$RemapCmd[$RemapCount] = "emoteExclaim";
$RemapCount++;
$RemapName[$RemapCount] = "Emote Love";
$RemapCmd[$RemapCount] = "emoteLove";
$RemapCount++;
$RemapName[$RemapCount] = "Emote AFK";
$RemapCmd[$RemapCount] = "emoteAFK";
$RemapCount++;

function restoreDefaultMappings()
{
   moveMap.delete();
   exec( "TBM/client/scripts/default.bind.cs" );
   OptRemapList.fillList();
}

function getMapDisplayName( %device, %action )
{
	if ( %device $= "keyboard" )
		return( %action );		
	else if ( strstr( %device, "mouse" ) != -1 )
	{
		// Substitute "mouse" for "button" in the action string:
		%pos = strstr( %action, "button" );
		if ( %pos != -1 )
		{
			%mods = getSubStr( %action, 0, %pos );
			%object = getSubStr( %action, %pos, 1000 );
			%instance = getSubStr( %object, strlen( "button" ), 1000 );
			return( %mods @ "mouse" @ ( %instance + 1 ) );
		}
		else
			error( "Mouse input object other than button passed to getDisplayMapName!" );
	}
	else if ( strstr( %device, "joystick" ) != -1 )
	{
		// Substitute "joystick" for "button" in the action string:
		%pos = strstr( %action, "button" );
		if ( %pos != -1 )
		{
			%mods = getSubStr( %action, 0, %pos );
			%object = getSubStr( %action, %pos, 1000 );
			%instance = getSubStr( %object, strlen( "button" ), 1000 );
			return( %mods @ "joystick" @ ( %instance + 1 ) );
		}
		else
	   { 
	      %pos = strstr( %action, "pov" );
         if ( %pos != -1 )
         {
            %wordCount = getWordCount( %action );
            %mods = %wordCount > 1 ? getWords( %action, 0, %wordCount - 2 ) @ " " : "";
            %object = getWord( %action, %wordCount - 1 );
            switch$ ( %object )
            {
               case "upov":   %object = "POV1 up";
               case "dpov":   %object = "POV1 down";
               case "lpov":   %object = "POV1 left";
               case "rpov":   %object = "POV1 right";
               case "upov2":  %object = "POV2 up";
               case "dpov2":  %object = "POV2 down";
               case "lpov2":  %object = "POV2 left";
               case "rpov2":  %object = "POV2 right";
               default:       %object = "??";
            }
            return( %mods @ %object );
         }
         else
            error( "Unsupported Joystick input object passed to getDisplayMapName!" );
      }
	}
		
	return( "??" );		
}

function buildFullMapString( %index )
{
   %name       = $RemapName[%index];
   %cmd        = $RemapCmd[%index];

	%temp = moveMap.getBinding( %cmd );
   %device = getField( %temp, 0 );
   %object = getField( %temp, 1 );
   if ( %device !$= "" && %object !$= "" )
	   %mapString = getMapDisplayName( %device, %object );
   else
      %mapString = "";

	return( %name TAB %mapString );
}

function OptRemapList::fillList( %this )
{
	%this.clear();
   for ( %i = 0; %i < $RemapCount; %i++ )
      %this.addRow( %i, buildFullMapString( %i ) );
}

//------------------------------------------------------------------------------
function OptRemapList::doRemap( %this )
{
	%selId = %this.getSelectedId();
   %name = $RemapName[%selId];

	OptRemapText.setValue( "REMAP \"" @ %name @ "\"" );
	OptRemapInputCtrl.index = %selId;
	Canvas.pushDialog( RemapDlg );
}

//------------------------------------------------------------------------------
function redoMapping( %device, %action, %cmd, %oldIndex, %newIndex )
{
	//%actionMap.bind( %device, %action, $RemapCmd[%newIndex] );
	moveMap.bind( %device, %action, %cmd );
	OptRemapList.setRowById( %oldIndex, buildFullMapString( %oldIndex ) );
	OptRemapList.setRowById( %newIndex, buildFullMapString( %newIndex ) );
}

//------------------------------------------------------------------------------
function findRemapCmdIndex( %command )
{
	for ( %i = 0; %i < $RemapCount; %i++ )
	{
		if ( %command $= $RemapCmd[%i] )
			return( %i );			
	}
	return( -1 );	
}

function OptRemapInputCtrl::onInputEvent( %this, %device, %action )
{
	//error( "** onInputEvent called - device = " @ %device @ ", action = " @ %action @ " **" );
	Canvas.popDialog( RemapDlg );

	// Test for the reserved keystrokes:
	if ( %device $= "keyboard" )
	{
      // Cancel...
      if ( %action $= "escape" )
      {
         // Do nothing...
		   return;
      }
	}
	
   %cmd  = $RemapCmd[%this.index];
   %name = $RemapName[%this.index];

	// First check to see if the given action is already mapped:
	%prevMap = moveMap.getCommand( %device, %action );
   if ( %prevMap !$= %cmd )
   {
	   if ( %prevMap $= "" )
	   {
         moveMap.bind( %device, %action, %cmd );
		   OptRemapList.setRowById( %this.index, buildFullMapString( %this.index ) );
	   }
	   else
	   {
         %mapName = getMapDisplayName( %device, %action );
		   %prevMapIndex = findRemapCmdIndex( %prevMap );
		   if ( %prevMapIndex == -1 )
			   MessageBoxOK( "REMAP FAILED", "\"" @ %mapName @ "\" is already bound to a non-remappable command!" );
		   else
         {
            %prevCmdName = $RemapName[%prevMapIndex];
			   MessageBoxYesNo( "WARNING", 
				   "\"" @ %mapName @ "\" is already bound to \"" 
					   @ %prevCmdName @ "\"!\nDo you want to undo this mapping?", 
				   "redoMapping(" @ %device @ ", \"" @ %action @ "\", \"" @ %cmd @ "\", " @ %prevMapIndex @ ", " @ %this.index @ ");", "" );
         }
		   return;
	   }
   }
}

// Audio 
function OptAudioUpdate()
{
   // set the driver text
   %text =   "Vendor: " @ alGetString("AL_VENDOR") @
           "\nVersion: " @ alGetString("AL_VERSION") @
           "\nRenderer: " @ alGetString("AL_RENDERER") @
           "\nExtensions: " @ alGetString("AL_EXTENSIONS");
   OptAudioInfo.setText(%text);

}


// Channel 0 is unused in-game, but is used here to test master volume.

new AudioDescription(AudioChannel0)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 0;
};

new AudioDescription(AudioChannel1)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 1;
};

new AudioDescription(AudioChannel2)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 2;
};

new AudioDescription(AudioChannel3)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 3;
};

new AudioDescription(AudioChannel4)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 4;
};

new AudioDescription(AudioChannel5)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 5;
};

new AudioDescription(AudioChannel6)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 6;
};

new AudioDescription(AudioChannel7)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 7;
};

new AudioDescription(AudioChannel8)
{
   volume   = 1.0;
   isLooping= false;
   is3D     = false;
   type     = 8;
};

$AudioTestHandle = 0;

function OptAudioUpdateMasterVolume(%volume)
{
   if (%volume == $pref::Audio::masterVolume)
      return;
   alxListenerf(AL_GAIN_LINEAR, %volume);
   $pref::Audio::masterVolume = %volume;
   if (!alxIsPlaying($AudioTestHandle))
   {
      $AudioTestHandle = alxCreateSource("AudioChannel0", expandFilename("~/data/sound/testing.wav"));
      alxPlay($AudioTestHandle);
   }
}

function OptAudioUpdateChannelVolume(%channel, %volume)
{
   if (%channel < 1 || %channel > 8)
      return;
         
   if (%volume == $pref::Audio::channelVolume[%channel])
      return;

   alxSetChannelVolume(%channel, %volume);
   $pref::Audio::channelVolume[%channel] = %volume;
   if (!alxIsPlaying($AudioTestHandle))
   {
      $AudioTestHandle = alxCreateSource("AudioChannel"@%channel, expandFilename("~/data/sound/testing.wav"));
      alxPlay($AudioTestHandle);
   }
}


function OptAudioDriverList::onSelect( %this, %id, %text )
{
   if (%text $= "")
      return;
   
   if ($pref::Audio::driver $= %text)
      return;

   $pref::Audio::driver = %text;
   OpenALInit();
}

function setPreviewBuilds_Saves() {
    if(!$Pref::GUI::BuildPreviews::useSaves && !$Pref::GUI::BuildPreviews::useiGobs) {
        $Pref::GUI::BuildPreviews::useiGobs = 1;
        chkbxPreviewBuildiGobs.setValue(1);
    }
}
function setPreviewBuilds_iGobs() {
    if(!$Pref::GUI::BuildPreviews::useSaves && !$Pref::GUI::BuildPreviews::useiGobs) {
        $Pref::GUI::BuildPreviews::useSaves = 1;
        chkbxPreviewBuildSaves.setValue(1);
    }
}