//texturecan.cs
//spray can shoots projectiles that change the color of bricks

$TotalTextures = 0;
$Texture[$TotalTextures] = 'base1';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base1.brickside";
$Texture[$TotalTextures++] = 'base2';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base2.brickside";
$Texture[$TotalTextures++] = 'base3';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base3.brickside";
$Texture[$TotalTextures++] = 'base4';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base4.brickside";
$Texture[$TotalTextures++] = 'base5';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base5.brickside";
$Texture[$TotalTextures++] = 'base6';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base6.brickside";
$Texture[$TotalTextures++] = 'base7';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base7.brickside";
$Texture[$TotalTextures++] = 'base8';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base8.brickside";
$Texture[$TotalTextures++] = 'base9';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base9.brickside";
$Texture[$TotalTextures++] = 'base10';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base10.brickside";
$Texture[$TotalTextures++] = 'base11';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base11.brickside";
$Texture[$TotalTextures++] = 'base12';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base12.brickside";
$Texture[$TotalTextures++] = 'base13';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base13.brickside";
$Texture[$TotalTextures++] = 'base14';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base14.brickside";
$Texture[$TotalTextures++] = 'base15';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base15.brickside";
$Texture[$TotalTextures++] = 'base16';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base16.brickside";
$Texture[$TotalTextures++] = 'base17';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base17.brickside";
$Texture[$TotalTextures++] = 'base18';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base18.brickside";
$Texture[$TotalTextures++] = 'base19';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base19.brickside";
$Texture[$TotalTextures++] = 'base20';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base20.brickside";
$Texture[$TotalTextures++] = 'base21';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base21.brickside";
$Texture[$TotalTextures++] = 'base22';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base22.brickside";
$Texture[$TotalTextures++] = 'base23';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base23.brickside";
$Texture[$TotalTextures++] = 'base24';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base24.brickside";
$Texture[$TotalTextures++] = 'base0';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/base0.brickside";
$Texture[$TotalTextures++] = 'construction';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/construction.blank";
$Texture[$TotalTextures++] = 't';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/t.brickside";
$Texture[$TotalTextures++] = '1';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/1.brickside";
$Texture[$TotalTextures++] = '2';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/2.brickside";
$Texture[$TotalTextures++] = '3';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/3.brickside";
$Texture[$TotalTextures++] = '4';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/4.brickside";
$Texture[$TotalTextures++] = '5';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/5.brickside";
$Texture[$TotalTextures++] = '6';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/6.brickside";
$Texture[$TotalTextures++] = '7';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/7.brickside";
$Texture[$TotalTextures++] = 'stone';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/stone.brickside";
$Texture[$TotalTextures++] = 'Deadra';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/Deadra.brickside";
$Texture[$TotalTextures++] = 'glass';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/glass.brickside";
$Texture[$TotalTextures++] = 'o';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/o.brickside";
$Texture[$TotalTextures++] = 'rainbow';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/rainbow.brickside";
$Texture[$TotalTextures++] = 'checkerWB';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/CheckerWB.brickside";
$Texture[$TotalTextures++] = 'CheckerRB';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/CheckerRB.brickside";
$Texture[$TotalTextures++] = 'RedCrystal';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/RedCrystal.brickside";
$Texture[$TotalTextures++] = 'gold';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/gold.brickside";
$Texture[$TotalTextures++] = 'bcarpet';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/bcarpet.brickside";
$Texture[$TotalTextures++] = 'grass';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/grass.brickside";
$Texture[$TotalTextures++] = 'greenhairline';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/greenhairline.brickside";
$Texture[$TotalTextures++] = 'redhairline';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/redhairline.brickside";
$Texture[$TotalTextures++] = 'bluehairline';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/bluehairline.brickside";
$Texture[$TotalTextures++] = 'yellowhairline';
$TexturePreview[$TotalTextures] = "rtb/data/shapes/bricks/yellowhairline.brickside";

//sound
datablock AudioProfile(sprayFireSound)
{
   filename    = "~/data/sound/sprayLoop.wav";
   description = AudioClosestLooping3d;
   preload = true;
};

datablock AudioProfile(sprayHitSound)
{
   filename    = "~/data/sound/sprayHit.wav";
   description = AudioClosest3d;
   preload = true;
};
datablock AudioProfile(sprayActivateSound)
{
   filename    = "~/data/sound/sprayActivate.wav";
   description = AudioClosest3d;
   preload = true;
};

datablock ProjectileData(textureCanProjectile)
{
   //projectileShapeName = "~/data/shapes/arrow.dts";
   //explosion           = textureCanExplosion;
   //particleEmitter     = textureCanTrailEmitter;

   muzzleVelocity      = 300;
   velInheritFactor    = 0;

   armingDelay         = 0;
   lifetime            = 100;
   fadeDelay           = 0;
   bounceElasticity    = 0;
   bounceFriction      = 0;
   isBallistic         = false;
   gravityMod = 0.0;

   hasLight    = false;
   lightRadius = 3.0;
   lightColor  = "0 0 0.5";
};

/////////
//ITEMS//
/////////
datablock ItemData(textureCan)
{
	category = "Tools";  // Mission editor category
	className = "tool";   // For inventory system

	 // Basic Item Properties
	shapeFile = "~/data/shapes/spraycan.dts";
	skinName = 'silver';
	rotate = false;
	mass = 1;
	density = 0.2;
	elasticity = 0.2;
	friction = 0.6;
	emap = false;
	cost = 30;

	 // Dynamic properties defined by the scripts
	pickUpName = 'a texture can.';
	invName = 'Texture Can';
	image = blueSprayCanImage;
};



//////////
//IMAGES//
//////////
datablock ShapeBaseImageData(textureCanImage)
{
   // Basic Item properties
   shapeFile = "~/data/shapes/spraycan.dts";
   skinName = 'silver';
   emap = false;
	cloakable = false;
   mountPoint = 0;
   offset = "0 0 0";

   correctMuzzleVector = true;

   // Add the WeaponImage namespace as a parent, WeaponImage namespace
   // provides some hooks into the inventory system.
   className = "WeaponImage";

   // Projectile && Ammo.
   item = textureCan;
   ammo = " ";
   projectile = textureCanProjectile;
   projectileType = Projectile;

   //melee particles shoot from eye node for consistancy
   melee = false;
   //raise your arm up or not
   armReady = true;

   //casing = " ";

   // Images have a state system which controls how the animations
   // are run, which sounds are played, script callbacks, etc. This
   // state system is downloaded to the client so that clients can
   // predict state changes and animate accordingly.  The following
   // system supports basic ready->fire->reload transitions as
   // well as a no-ammo->dryfire idle state.

   // Initial start up state
	stateName[0]                     = "Activate";
	stateTimeoutValue[0]             = 0.0;
	stateTransitionOnTimeout[0]       = "Ready";
	stateSound[0]					= sprayActivateSound;

	stateName[1]                    = "Ready";
	stateTransitionOnTriggerDown[1] = "Fire";
	stateAllowImageChange[1]        = true;
	

	stateName[2]					= "Fire";
	stateScript[2]                  = "onFire";
	stateFire[2]					= true;
	stateAllowImageChange[2]        = true;
	stateTimeoutValue[2]            = 0.10;
	stateTransitionOnTimeout[2]     = "Fire";
	stateTransitionOnTriggerUp[2]	= "Ready";
	//stateEmitter[2]					= sprayCanExplosionEmitter;
	//stateEmitterTime[2]				= 0.1;
	stateSound[2]					= sprayFireSound;

};

///////////
//METHODS//
///////////
//using the paint can item
function textureCan::onUse(%this,%player, %invPosition)
{
	%client = %player.client;
	if(%client)
	{
		%color = %client.color;
	}
	%mountedImage = %player.getMountedImage($RightHandSlot);

	//if a spray can is already mounted
	if(%mountedImage.item $= "textureCan" && (%player.currWeaponSlot == %invPosition)) 
	{
		%client.textureIndex++;

		if(%client.textureIndex > $Totaltextures)
		{
			%client.textureIndex = 0;
		}	
		commandtoclient(%client,'ShowBrickImage',$texturePreview[%client.textureIndex]);
	}
	else 
	{
		//if the client has a color, use that
		%image = nameToID("textureCanImage");
		%player.mountImage(%image, $RightHandSlot, 1, %image.skinName);
		//hilight inv slot
		messageClient(%client, 'MsgHilightInv', '', %InvPosition);
		%player.currWeaponSlot = %invPosition;
		%client.color = $texture[%obj.client.textureIndex];
		commandtoclient(%client,'ShowBrickImage',$texturePreview[%client.textureIndex]);
	}
}

//Collisions//

function textureCanProjectile::onCollision(%this,%obj,%col,%fade,%pos,%normal)
{
	%isTrusted = checkSafe(%col,%obj.client);
	
	if(%obj.client.isImprisoned)
	{
		messageClient(%client,'',"\c4No painting you imprisoned, no good, piece of poo!");
		return;
	}

	if(%col.owner == %obj.client || (%col.owner.secure == 0 && %col.OwnerAway == 0)|| %isTrusted || %obj.client.isAdmin || %obj.client.isSuperAdmin)
	{
		if(%col.getClassName() $= "WheeledVehicle"|| %col.getClassName() $= "StaticShape" || %col.getClassName() $= "Player")
		{
			//-----------------------PTTA-------------------------
			if (%col.getClassName() $= "Player")
			{
			if (%col.client.isAdmin || %col.client.isSuperAdmin)
			{
			messageClient(%obj.client,'','\c2You can\'t paint Admins!');
			return;
			}
			}
			//-----------------------------------------------------
			if(%col.getSkinName() !$= $texture[%obj.client.textureIndex])
			{	
				%obj.client.Undo[0] = 1;
				%obj.client.Undo[1] = %col;
				%obj.client.Undo[2] = %col.getSkinName();
				%col.setSkinName($texture[%obj.client.textureIndex]);		
				%col.SkinName = %col.getSkinName();
				if(%col.Datablock $= "staticbrick2x2FX")
				{
					if(%col.FXMode $= 1)
					{
					%position = %col.flameEmitter.getTransform();
					%col.flameEmitter.delete();
					%testtexture = %obj.client.textureIndex;
					if(%testtexture $= "11")
					{
			   			%col.flameEmitter = new ParticleEmitterNode(brickFireNode) {
     			   			position = %position;
      			   			rotation = "1 0 0 0";
	      		   			scale = "1 1 1";
      			   			dataBlock = "FireParticleEmitterNode";
     		   	   			emitter = "FireParticleEmitter2";
      			   			velocity = "1.0";
   			  			};
					}
					else if(%testtexture $= "8")
					{
			   			%col.flameEmitter = new ParticleEmitterNode(brickFireNode) {
     			   			position = %position;
      			   			rotation = "1 0 0 0";
	      		   			scale = "1 1 1";
      			   			dataBlock = "FireParticleEmitterNode";
     		   	   			emitter = "FireParticleEmitter3";
      			   			velocity = "1.0";
   			  			};
					}
					else if(%testtexture $= "14")
					{
			   			%col.flameEmitter = new ParticleEmitterNode(brickFireNode) {
     			   			position = %position;
      			   			rotation = "1 0 0 0";
	      		   			scale = "1 1 1";
      			   			dataBlock = "FireParticleEmitterNode";
     		   	   			emitter = "FireParticleEmitter4";
      			   			velocity = "1.0";
   			  			};
					}
					else if(%testtexture $= "1")
					{
			   			%col.flameEmitter = new ParticleEmitterNode(brickFireNode) {
     			   			position = %position;
      			   			rotation = "1 0 0 0";
	      		   			scale = "1 1 1";
      			   			dataBlock = "FireParticleEmitterNode";
     		   	   			emitter = "FireParticleEmitter5";
      			   			velocity = "1.0";
   			  			};
					}
					else
					{
			   			%col.flameEmitter = new ParticleEmitterNode(brickFireNode) {
     			   			position = %position;
      			   			rotation = "1 0 0 0";
	      		   			scale = "1 1 1";
      			   			dataBlock = "FireParticleEmitterNode";
     		   	   			emitter = "FireParticleEmitter";
      			   			velocity = "1.0";
   			  			};
					}
					}

				}	
			}
		}
	}
}

function checkSafe(%col,%client)
{
	%isTrusted = 0;

	for(%trusted = 0; %trusted < clientGroup.GetCount(); %trusted++)
	{
		//echo(clientGroup.GetCount());
		%cl = clientGroup.getObject(%trusted);
		//echo(%cl);
		for(%safe = 0; %safe < %col.Owner.SafeListNum + 1; %safe++)
		{
			//echo(%col.Owner.SafeList[%safe]);
			if(%col.Owner.SafeList[%safe] == %cl && %cl == %client)
			{
				%isTrusted = 1;
			}
		}

	} 
	return %isTrusted;
}
function getFriends(%client, %person)
{
	%isFriend = 0;

	for(%friend = 0; %friend < %client.FriendListNum + 1; %friend++)
	{
		if(%client.FriendList[%friend] $= %person)
		{
			%isFriend = 1;
		}
	}
	return %isFriend;
}
function getSafe(%client, %person)
{
	%isSafe = 0;

	for(%safe = 0; %safe < %client.SafeListNum + 1; %safe++)
	{
		if(%client.SafeList[%safe] $= %person)
		{
			%isSafe = 1;
		}
	}
	return %isSafe;
}